<html>
<head>
<title>Headto</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">

<style>
p {
  margin: 0 0 10px 0;
}

.title {
  margin: 20px 0 0 0;
  font-size: 64px;
}

.title a {
  text-decoration: none;
}

.search {
  position: relative;
  *z-index: 1;
  margin: 50px 0;
}

.typeahead {
  background-color: #fff;
}

.tt-hint {
  color: #999
}

.tt-dropdown-menu {
  transition: display 2s;
  -webkit-transition: display 2s; /* Safari */
  text-align: left;
}

.tt-suggestion {
  padding: 3px 20px;
  font-size: 18px;
  line-height: 24px;
}

.tt-suggestion.tt-is-under-cursor {
  color: #fff;
  background-color: #0097cf;
}

.tt-suggestion p {
  margin: 0;
}

.search .tt-suggestion {
  padding: 8px 20px;
}

.search .tt-suggestion + .tt-suggestion {
  border-top: 1px solid #ccc;
}

.search .venue-icon {
  width: 50px;
  float: left;
}

.search .venue-name {
  padding: 0 63px;
  font-weight: bold;
}

.search .venue-address {
  padding: 0 63px;
  font-size: 14px;
}


.tt-dropdown-menu {
  width: 100%;
  padding: 0;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 0 0 5px 5px;
}

.typeahead:focus {
  border: 2px solid #0097cf;
}

.typeahead,
.tt-query,
.tt-hint {
  width: 396px;
  height: 30px;
  padding: 20px;
  font-size: 24px;
  line-height: 30px;
  border: 2px solid #ccc;
  border-radius: 5px;
  outline: none;
}
</style>
<style>

.loading {
  position: absolute;
  top: 12px;
	left: 730px;	
	width: 20px;
	height: 20px;
	border-style: solid;
	border-radius: 20px;				
	border-width: 5px;
  border-color: green white green white;
	-webkit-animation: revolve 1s linear infinite; 
	-moz-animation: revolve 1s linear infinite;
	animation: revolve 1s linear infinite; /* IE10+ */  
}

@-webkit-keyframes revolve  
{  
	from { -webkit-transform: rotate(0deg); }  
	50%  { -webkit-transform: rotate(180deg); }  
	to   { -webkit-transform: rotate(360deg); }  
}

@-moz-keyframes revolve  
{  
	from { -moz-transform: rotate(0deg); }  
	50%  { -moz-transform: rotate(180deg); }  
	to   { -moz-transform: rotate(360deg); }  
}

@keyframes revolve  /* IE10+ */
{  
	from { transform: rotate(0deg); }  
	50%  { transform: rotate(180deg); }  
	to   { transform: rotate(360deg); }  
}
</style>

</head>

<body>

<div id="fb-root"></div>
<script type="text/javascript">

  window.fbAsyncInit = function() {
    FB.init({
      appId      : 479332218823511,        // App ID
      status     : true,           // check login status
      cookie     : true,           // enable cookies to allow the server to access the session
      xfbml      : false            // parse page for xfbml or html5 social plugins like login button below
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/all.js";
     fjs.parentNode.insertBefore(js, fjs);
 }(document, 'script', 'facebook-jssdk'));

</script>

<div class="container text-center">
<h1 class="title"><a href="/">Headto</a></h1>
<p>Tell your friends where you are heading.</p>

<div class="search">
  <input class="typeahead" type="text" placeholder="Where are you heading?"><span id="loader"></span>
</div>

<div class="result">
</div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://twitter.github.com/hogan.js/builds/2.0.0/hogan-2.0.0.js"></script>
<script src="http://twitter.github.io/typeahead.js/releases/latest/typeahead.js"></script>

<script>
var foursquareURL = "https://api.foursquare.com/v2/venues/suggestcompletion?" + "client_id=EBA5MTZIPRVHNGKU2RB4KZ45J2BAOZFSYIXHGYBGR1KIXFIQ&" + "client_secret=K0CBX5TQKHNEB35MGT3NNIVLWP0C4L0CQQ4UP3C2LUSLQL0W&" + "v=20130725&" + "limit=10&" + "near=Bangalore&" + "query=%QUERY";
 
function parseFoursquareResponse(res) {
  $('#loader').removeClass('loading');
  console.log(res.response.minivenues);
  return res.response.minivenues;
};

function renderContent(loc) {

  document.title = "Headto - " + loc.name;

  //address: "2 Church St."
  //city: "Bengaluru"
  //country: "India"
  //crossStreet: ""
  //lat: 12.974386636007539
  //lng: 77.60735750198364
  //postalCode: "560001"
  //state: "Karnataka"

  var result = "";
  result += '<div>';
  result += '<strong>' + loc.categories[0].name + '</strong>';
  result += '<p>' + loc.location.address + ', ' + loc.location.city + '.</p>';
  result += '<p><a class="btn btn-lg btn-primary" id="postHeadto">I\'m heading here</a></p>';
  result += '</div>';
  result += '<img src="//a.tiles.mapbox.com/v3/paramaggarwal.map-mkz04dpf/pin-m-star';
  result += '(' + loc.location.lng + ',' + loc.location.lat + ')';
  result += '/' + loc.location.lng + ',' + loc.location.lat + ',14/400x200.png">';

  $(".result").html(result);

  $('#postHeadto').click(function() {
    postHeadto(loc.id);
  });

}

function postHeadto(venueID) {
  alert("Ready to post! ID: " + venueID);

  FB.getLoginStatus(function(response) {
      if (response.status === 'connected') {
        // the user is logged in and has authenticated your
        // app, and response.authResponse supplies
        // the user's ID, a valid access token, a signed
        // request, and the time the access token 
        // and signed request each expire
        // var uid = response.authResponse.userID;
        // var accessToken = response.authResponse.accessToken;
        console.log("User is already logged in, posting to Facebook");
        postGraphAction(venueID);

      } else if (response.status === 'not_authorized') {
        // the user is logged in to Facebook, 
        // but has not authenticated your app
        FB.login(function(response) {
         if (response.authResponse) {
           console.log('Welcome!  Fetching your information.... ');
           FB.api('/me', function(response) {
             console.log('Good to see you, ' + response.name + '.');
           });
           postGraphAction(venueID);
         } else {
           console.log('User cancelled login or did not fully authorize.');
         }
       }, {scope: 'email, publish_actions'});
      } else {
        // the user isn't logged in to Facebook.
        FB.login(function(response) {
         if (response.authResponse) {
           console.log('Welcome!  Fetching your information.... ');
           FB.api('/me', function(response) {
             console.log('Good to see you, ' + response.name + '.');
             postGraphAction(venueID);
           });
         } else {
           console.log('User cancelled login or did not fully authorize.');
         }
       }, {scope: 'email, publish_actions'});
      }
    });
}

function postGraphAction(venueID) {
  var venueURL = "/venue/" + venueID;

  FB.api(
    'me/headtoapp:head_to',
    'post',
    {
      venue: venueURL,
      expires_in : 4*60*60
    },
    function(response) {
      if (!response) {
       console.log('Error occurred.');
     } else if (response.error) {
       console.log('Error: ' + response.error.message);
     } else {
       console.log('<a href=\"https://www.facebook.com/me/activity/' + response.id + '\">' +
         'Story created.  ID is ' + response.id + '</a>');
       window.location.assign("https://www.facebook.com/me/activity/" + response.id)
     }
   });
}

$(document).ready(function() {
  $('.typeahead').typeahead({
    name: 'headtoapp-search',
    valueKey: 'name',
    remote: {
      url: foursquareURL,
      filter: parseFoursquareResponse,
      cache: true,
      beforeSend: function () {
        $('#loader').addClass('loading');
      }
    },
    template: [
      '<div class="venue-icon"><img src="{{categories.0.icon.prefix}}bg_44{{categories.0.icon.suffix}}" /></div>',
      '<div class="venue-name">{{name}}</div>',
      '<div class="venue-address">{{location.address}}<br>{{location.crossStreet}}</div>',
      ].join(''),
    engine: Hogan
  });

  $(document).on("typeahead:selected", function(e, loc) {
    var locationSuffix = "/venue/" + loc.id;

    //Push only if already not on same page to avoid redundancy
    if(window.location.href.indexOf(locationSuffix) == -1)
      window.history.pushState(loc, null, locationSuffix);

    renderContent(loc);
  });

  window.addEventListener("popstate", function(e) {
    if(e.state) {
      renderContent(e.state);
      $("input.typeahead").val(e.state.name);
    }
  });

});

</script>
</body>
</html>
